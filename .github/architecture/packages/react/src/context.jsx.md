# `packages/react/src/context.jsx`

<!--
source: packages/react/src/context.jsx
category: storyboard
importance: high
-->

> [← Architecture Index](../../../../architecture.index.md)

## Goal

The `StoryboardProvider` component is the root of the Storyboard data layer in React. It loads scene data synchronously from the pre-built data index, optionally merges record data for dynamic routes, and exposes everything through React context so any descendant hook can read scene data without prop drilling.

The provider is intentionally **synchronous** — all JSON data is pre-parsed at build time by the Vite data plugin, so `loadScene()` never performs I/O at runtime. The `loading` field in the context value is always `false`.

## Composition

### Exports

| Export | Kind | Description |
|--------|------|-------------|
| `StoryboardProvider` | default export | React context provider component |
| `StoryboardContext` | named re-export | The raw context object (from [`./StoryboardContext.js`](./StoryboardContext.js.md)) |

### Key internal functions

**`getSceneParam()`** — Reads `?scene=` directly from `window.location` (not React Router) to avoid re-renders on hash changes:

```js
function getSceneParam() {
  return new URLSearchParams(window.location.search).get('scene')
}
```

**`getPageSceneName()`** — Derives a scene name from the current pathname (`/Overview` → `"Overview"`, `/` → `"index"`):

```js
function getPageSceneName() {
  const path = window.location.pathname.replace(/\/+$/, '') || '/'
  if (path === '/') return 'index'
  const last = path.split('/').pop()
  return last || 'index'
}
```

### Scene resolution order

1. `?scene=` URL param (via `getSceneParam()`)
2. `sceneName` prop passed to the provider
3. Auto-matching: if a scene file exists whose name matches the current page
4. Fallback: `"default"`

### Record merging

When `recordName` and `recordParam` props are set, the provider looks up a record entry via `findRecord()` using the matching React Router URL param, then deep-merges it under `data.record`:

```js
if (recordName && recordParam && params[recordParam]) {
  const entry = findRecord(recordName, params[recordParam])
  if (entry) sceneData = deepMerge(sceneData, { record: entry })
}
```

### Context value shape

```js
{ data: object | null, error: string | null, loading: false, sceneName: string }
```

On error, the component renders an inline error message instead of its children.

## Dependencies

| Module | Purpose |
|--------|---------|
| `react` | `useMemo`, `useParams` |
| `react-router-dom` | `useParams` for dynamic route params |
| `virtual:storyboard-data-index` | Side-effect import — seeds the core data index at module load |
| `@dfosco/storyboard-core` | `loadScene`, `sceneExists`, `findRecord`, `deepMerge` |
| [`./StoryboardContext.js`](./StoryboardContext.js.md) | The React context object |

## Dependents

- [`packages/react/src/index.js`](./index.js.md) — re-exports `StoryboardProvider` as the default export of the package
- `src/pages/_app.jsx` — wraps the entire app in `<StoryboardProvider>`

## Notes

- `useSearchParams()` is intentionally avoided; it re-renders on every React Router navigation (including hash changes), which causes a visible flash. Reading `window.location.search` directly eliminates this.
- The `virtual:storyboard-data-index` import is a side-effect-only import. It is generated by the [`data-plugin.js`](./vite/data-plugin.js.md) Vite plugin and calls `init()` from `@dfosco/storyboard-core` to populate the data index before any `loadScene()` call.
